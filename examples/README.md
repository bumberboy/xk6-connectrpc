# xk6-connectrpc Examples

This folder contains example k6 scripts demonstrating how to use the xk6-connectrpc extension.

## Prerequisites

1. Build k6 with the connectrpc extension:
   ```bash
   xk6 build --with github.com/bumberboy/xk6-connectrpc@latest
   ```

2. For the generated client example, install the protoc plugin:
   ```bash
   go install github.com/bumberboy/xk6-connectrpc/protoc-gen-k6-connectrpc@latest
   ```

## Examples

### 1. Generated Client Example (`generated-client-example.js`) ‚≠ê **Recommended**

Demonstrates using clients generated by `protoc-gen-k6-connectrpc` with the Eliza service from buf schema registry.

**Setup:**
```bash
# Generate the client (requires protoc-gen-k6-connectrpc in PATH)
buf generate

# Run the example
./k6 run examples/generated-client-example.js
```

**Features:**
- **Zero setup** - proto definitions automatically embedded
- **Buf schema registry integration** - uses `buf.build/connectrpc/eliza`
- **All RPC patterns** - unary, server streaming, bidirectional streaming
- **Type-safe client methods** - generated from proto definitions
- **Real service testing** - connects to `https://demo.connectrpc.com`

### 2. Unary RPC Calls (`unary-example.js`)

Demonstrates basic unary RPC calls using the raw xk6-connectrpc API with manual proto loading.

**Run:**
```bash
./k6 run examples/unary-example.js
```

**Features:**
- Connection establishment
- Single request-response calls
- Response validation
- Metrics collection

### 3. Bidirectional Streaming (`streaming-example.js`)

Shows how to use bidirectional streaming with the raw xk6-connectrpc API.

**Run:**
```bash
./k6 run examples/streaming-example.js
```

**Features:**
- Bidirectional streaming
- Event-driven message handling
- Stream lifecycle management
- Async/await patterns

### 4. Full Integration Test (`test-connectrpc-clown.js`)

Comprehensive example that tests both unary and streaming operations with detailed metrics using custom proto files.

**Run:**
```bash
./k6 run examples/test-connectrpc-clown.js
```

**Features:**
- Multiple test scenarios
- Comprehensive metrics and thresholds
- Connection reuse patterns
- Error handling

## Two Approaches to Using xk6-connectrpc

### 1. Generated Clients (Recommended) üöÄ

Use `protoc-gen-k6-connectrpc` to generate type-safe client wrappers:

**Pros:**
- ‚úÖ Zero setup - proto definitions automatically embedded
- ‚úÖ Type-safe method calls with proper names
- ‚úÖ Works with buf schema registry modules
- ‚úÖ Automatic streaming wrapper generation
- ‚úÖ No manual proto loading required

**Example:** `generated-client-example.js`

### 2. Raw API (Manual)

Use the xk6-connectrpc API directly with manual proto loading:

**Pros:**
- ‚úÖ Full control over connection and call parameters
- ‚úÖ Works with any proto files
- ‚úÖ No code generation step required

**Cons:**
- ‚ùå Manual proto loading required
- ‚ùå Manual method path construction
- ‚ùå More boilerplate code

**Examples:** `unary-example.js`, `streaming-example.js`, `test-connectrpc-clown.js`

## Customizing Examples

### For Generated Client Examples:
1. Update `buf.gen.yaml` to point to your buf module or local proto files
2. Run `buf generate` to regenerate clients
3. Update service URLs and test data in the scripts

### For Raw API Examples:
1. Replace `clown.proto` with your own proto file
2. Update the service URLs in the scripts
3. Modify the RPC method names and message structures
4. Adjust the test thresholds based on your performance requirements

## Protocol and Content Type Combinations

These examples can be easily modified to test different protocol combinations:

- **Connect + JSON**: `protocol: 'connect', contentType: 'application/json'`
- **Connect + Protobuf**: `protocol: 'connect', contentType: 'application/proto'`
- **gRPC + Protobuf**: `protocol: 'grpc', contentType: 'application/protobuf'`
- **gRPC-Web + JSON**: `protocol: 'grpc-web', contentType: 'application/json'` 